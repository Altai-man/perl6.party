%% title: Perl 6 Core Hacking: Can't See The QAST Nodes For The Trees
%% date: 2018-01-26
%% desc: Overview of "Q" Abstract Syntax Trees
%% draft: True

Over the past month, I spent some time in Rakudo's QAST land writing a few
optimizations, fixing bugs involving warnings, as well as squashing a monster
hive of 10 thunk scoping bugs with a single commit. In today's article,
we'll g over that last feat in detail, as well as learn what QAST is and how
to work with it.

## Dumping QAST

QAST stands for *"Q" Abstract Syntax Tree*. The "Q" is there because it's
one-after "P", and "P" used to be there to stand for *"Parrot"*, the name of
an earlier, experimental Perl 6 implementation. Every Rakudo Perl 6 program
compiles down to a tree of QAST nodes and you can dump that tree if you specify
`--target=ast` or `--target=optimize` command line option to `perl6` when
compiling a program or a module:

    $ perl6 --target=ast -e 'say "Hello, World!"'
    [...]
    - QAST::Op(call &say) <sunk> :statement_id<?> say \"Hello, World!\"
      - QAST::Want <wanted> Hello, World!
        - QAST::WVal(Str)
        - Ss
        - QAST::SVal(Hello, World!)
    [...]

The difference between the `--target=ast` and `--target=optimize` is that
the former shows the QAST tree as soon as it has been generated, while
the later shows the QAST tree after the static optimizer has had a go at it.

While the command line option gives you the QAST for the entire program, each
[`QAST::Node` object](https://github.com/perl6/nqp/blob/master/src/QAST/Node.nqp) has `.dump` method you can use to dump specific QAST pieces of interest
from within Rakudo's source code.

For example, to examine the QAST generated by the `statement` token, I'd
find [`method statement`](https://github.com/rakudo/rakudo/blob/49dce163e8182ee726cd1e512a03c29551cc16da/src/Perl6/Actions.nqp#L1396) in `src/Perl6/Actions.nqp` and stick `nqp::say('statement QAST: ' ~ $past.dump)` close to the end of
the method.

Since Rakudo's compilation takes a couple of minutes for each go, I like to
key my debug dumps on env variables, like this:

    nqp::atkey(nqp::getenvhash(),'ZZ1') && nqp::say('ZZ1: something or other');
    ...
    nqp::atkey(nqp::getenvhash(),'ZZ2') && nqp::say('ZZ2: something else');

Then, I can execute the compiled `./perl6` as if I didn't add anything, and
enable my dumps by running `ZZ1=1 ./perl6`, `ZZ2=1 ./perl6`, or both dumps
at the same time with `ZZ1=1 ZZ2=1 ./perl6`.

## Viewing QAST

Looking at the output of `--target` dumps in the terminal is sufficient
for a quickie glance at the trees, but for extra assistance you can install
[`CoreHackers::Q` module](https://modules.perl6.org/dist/CoreHackers::Q) that
brings in `q` command line utility.

Simply prefix your regular `perl6` invocation with `q a` or q o` to produce
`--target=ast` and `--target=optimize` QAST dumps respectively. The program
will generate `out.html` file in the current directory:

    $ q a perl6 -e 'say "Hello, World!"'
    $ firefox out.html

Pop open the generated HTML file and reap these benefits:

* Color-coded QAST nodes
* Color hints for sunk nodes
* Ctrl+Click on any node to collapse it
* Muted view of QAST::Want alternatives, makes easier to ignore them

Eventually, I hope to extend this tool and make it more helpful, but at the
time of this writing, that's all it does.

## The QAST Forest

There are four main files in
[rakudo's source](https://github.com/rakudo/rakudo/)
would be the place where you'd expect to be working with QAST
nodes: `src/Perl6/Grammar.nqp`, `src/Perl6/Actions.nqp`, `src/Perl6/World.nqp`,
and `src/Perl6/Optimizer.nqp`. If you're using [`ZScript` utility](https://github.com/zoffixznet/z), you can even run `z q` command to open these
four files in [`Atom` editor](https://github.com/perl6/Atom-as-a-Perl6-IDE).

`Grammar.nqp` is the Perl 6 grammar. `Actions.nqp` are the actions for it.
`World.nqp` contains all sorts of helpful routines used by both `Grammar.nqp`
and `Actions.nqp` (the `$*W` dynamic variable contains a `Perl6::World`
object). Lastly, `Optimizer.nqp` contains Rakudo's static optimizer.

## Executing QAST Trees

Having a decent familarity with
[nqp ops](https://github.com/perl6/nqp/blob/master/docs/ops.markdown)
(as well as [Rakudo's nqp extensions](https://github.com/rakudo/rakudo/blob/master/docs/ops.markdown)) is helpful when working with
QAST. A sharp eye would notice in QAST dumps that `QAST::Op` nodes correspond
to `nqp::*` op calls, where `:op` named argument specifies the name of the
op.

When writing large QAST trees, it's handy to write them down using pure NQP
ops. Let's look at a simplified example:

    nqp::say('Hello, World!');

We have an NQP op, so we'll start with `QAST::Op` node, using `'say'` as the
value for `:op`. The op takes a single argument: a string to print, so we'll
give it a single `QAST::SVal` node, with the string we want to print as
`:value`:

    QAST::Op.new(:op('say'),
      QAST::SVal.new(:value('Hello, World!')));

I find it easier to track the tree's nesting by using parentheses
only when necessary,
using [colon method call](https://docs.perl6.org/language/syntax#Precedence_Drop) syntax whenever possible:

    QAST::Op.new: :op<say>,
      QAST::SVal.new: :value('Hello, World!');

If a `.new` is followed by a colon, we're descending and there aren't any
more ops on the same level. If `.new` is followed by an opening parentheses,
there are more sister nodes yet to come.

Due to Rakudo's lengthy compilation, it can be handy to execute your QAST tree
without having to stick it into `src/Perl6/Actions.nqp` or similar file first.
To some extent, it's possible to do that with a regular Perl 6 program. We'll
simply access `Perl6::World` object in `$*W` variable inside a `BEGIN` block
where it still exists, and call `.compile_time_evaluate` method, giving it
an empty param as first positional (it expects a `Match` object for the tree)
and our QAST tree as second positional:

    use QAST:from<NQP>;
    BEGIN $*W.compile_time_evaluate: $,
      QAST::Op.new: :op<say>,
        QAST::SVal.new: :value('Hello, World!');
